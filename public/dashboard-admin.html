<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - RizxMods</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-800 min-h-screen text-white flex flex-col items-center">

  <!-- Header -->
  <div class="w-full max-w-4xl mt-8 animate-fadein">
    <div class="flex items-center justify-between mb-7">
      <h1 class="text-3xl md:text-4xl font-extrabold flex items-center gap-2 drop-shadow-lg">
        <span class="animate-logo-bounce text-yellow-400">üëë</span> 
        <span>Admin Panel - RizxMods</span>
      </h1>
    </div>
  </div>

  <div id="adminContent" class="w-full max-w-4xl p-6 rounded-2xl bg-slate-900/80 shadow-2xl animate-pop">
    <!-- Tambah Reseller -->
    <button onclick="openAddReseller()" class="bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 hover:from-green-600 hover:to-teal-700 text-white font-semibold py-2 px-6 rounded-xl mb-7 shadow-lg transition-transform active:scale-95 animate-btnpop">
      + Tambah Reseller
    </button>

    <!-- Daftar Reseller -->
    <div class="mb-8 animate-pop">
      <h2 class="text-xl font-bold mb-2 flex items-center gap-2">
        <span>üìÇ</span>Daftar Reseller
      </h2>
      <div class="overflow-x-auto rounded-lg shadow-inner">
        <table class="min-w-full text-sm text-slate-100">
          <thead>
            <tr class="bg-slate-800/80 text-indigo-300">
              <th class="p-3">Username</th>
              <th class="p-3">Ganti Password</th>
              <th class="p-3">Aksi</th>
            </tr>
          </thead>
          <tbody class="bg-slate-900" id="resellerTable"></tbody>
        </table>
      </div>
    </div>

    <!-- List Panel/Server -->
    <div class="animate-pop">
      <h2 class="text-xl font-bold mb-2 flex items-center gap-2 mt-8">
        <span>üñ•Ô∏è</span>List Panel/Server
      </h2>
      <div class="overflow-x-auto rounded-lg shadow-inner">
        <table class="min-w-full text-sm text-slate-100">
          <thead>
            <tr class="bg-slate-800/80 text-indigo-300">
              <th class="p-3">ID</th>
              <th class="p-3">Nama Panel</th>
              <th class="p-3">Pemilik</th>
              <th class="p-3">Status</th>
            </tr>
          </thead>
          <tbody class="bg-slate-900" id="serverTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Tambah Reseller -->
  <div id="addResellerModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
    <form id="addResellerForm" class="bg-slate-800 p-7 rounded-2xl w-full max-w-sm mx-4 space-y-4 shadow-xl animate-pop">
      <h2 class="text-xl font-bold text-center text-indigo-400 mb-3">‚ûï Tambah Reseller</h2>
      <input type="text" id="newResellerUsername" placeholder="Username" required class="w-full p-3 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      <input type="password" id="newResellerPassword" placeholder="Password" required class="w-full p-3 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      <div class="flex gap-2 pt-2">
        <button type="submit" class="bg-gradient-to-r from-green-500 to-emerald-600 p-2 rounded-xl w-full font-semibold">Simpan</button>
        <button type="button" onclick="closeAddReseller()" class="bg-red-600 p-2 rounded-xl w-full font-semibold">Batal</button>
      </div>
    </form>
  </div>

  <!-- Modal Notifikasi Animasi -->
  <div id="notifyModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
    <div class="bg-slate-800 px-8 py-8 rounded-2xl shadow-xl text-center animate-pop">
      <div class="text-4xl mb-2 animate-celebrate" id="notifyIcon">‚úÖ</div>
      <div class="font-bold text-lg mb-2" id="notifyMsg"></div>
      <button onclick="closeNotifyModal()" class="mt-3 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-xl text-white font-semibold shadow animate-btnpop">Tutup</button>
    </div>
  </div>

  <style>
    @keyframes pop {
      0% { transform: scale(0.87); opacity: 0;}
      100% { transform: scale(1); opacity: 1;}
    }
    .animate-pop { animation: pop 0.33s cubic-bezier(.4,2,.6,1);}
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-28px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .animate-fadein { animation: fadein 0.7s cubic-bezier(.4,2,.6,1);}
    @keyframes celebrate {
      0%,100% { transform: rotate(0deg);}
      20% { transform: rotate(-12deg);}
      40% { transform: rotate(10deg);}
      60% { transform: rotate(-8deg);}
      80% { transform: rotate(6deg);}
    }
    .animate-celebrate { animation: celebrate 0.85s; }
    @keyframes btnpop {
      0% { transform: scale(0.96);}
      100% { transform: scale(1);}
    }
    .animate-btnpop { animation: btnpop 0.19s; }
    @keyframes logo-bounce {
      0%,100% { transform: translateY(0);}
      50% { transform: translateY(-7px);}
    }
    .animate-logo-bounce { animation: logo-bounce 2.3s infinite;}
    /* Table hover row */
    #adminContent tbody tr:hover { background: #3730a3 !important; transition: background 0.2s; }
  </style>

  <script>
    // Modal notifikasi animasi
    function showNotifyModal(msg, icon="‚úÖ") {
      document.getElementById("notifyMsg").innerText = msg;
      document.getElementById("notifyIcon").innerText = icon;
      document.getElementById("notifyModal").classList.remove("hidden");
    }
    function closeNotifyModal() {
      document.getElementById("notifyModal").classList.add("hidden");
    }

    // ‚ûï Modal Tambah Reseller
    function openAddReseller() {
      document.getElementById("addResellerModal").classList.remove("hidden");
    }
    function closeAddReseller() {
      document.getElementById("addResellerModal").classList.add("hidden");
    }

    // üìù Tambah Reseller
    document.getElementById("addResellerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("newResellerUsername").value.trim();
      const password = document.getElementById("newResellerPassword").value.trim();
      const res = await fetch("/api/resellers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        closeAddReseller();
        loadResellers();
        showNotifyModal("Reseller ditambahkan!", "‚úÖ");
      } else {
        showNotifyModal("Gagal menambah reseller.", "‚ùå");
      }
    });

    // üìã List Reseller + Ganti Password
    async function loadResellers() {
      const tbody = document.getElementById('resellerTable');
      tbody.innerHTML = "<tr><td colspan='3' class='p-4 text-center text-indigo-300 animate-fadein'>Memuat...</td></tr>";
      try {
        const res = await fetch("/api/resellers");
        const data = await res.json();
        let resArr = Array.isArray(data) ? data : data.resellers || [];
        if (!resArr.length) {
          tbody.innerHTML = "<tr><td colspan='3' class='p-4 text-center text-slate-300 animate-fadein'>Belum ada reseller.</td></tr>";
          return;
        }
        tbody.innerHTML = "";
        resArr.forEach(r => {
          tbody.innerHTML += `
            <tr class="border-b border-slate-800">
              <td class="p-3">@${r.username}</td>
              <td class="p-3">
                <input type="password" id="newpass-${r.username}" class="bg-slate-700 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="Password baru" />
                <button onclick="gantiPasswordReseller('${r.username}')" class="ml-2 bg-yellow-400 hover:bg-yellow-500 text-slate-900 px-3 rounded font-semibold text-xs animate-btnpop">Simpan</button>
              </td>
              <td class="p-3">
                <button onclick="deleteReseller('${r.username}')" class="bg-red-600 hover:bg-red-700 rounded px-3 py-1 text-xs font-semibold animate-btnpop">Hapus</button>
              </td>
            </tr>
          `;
        });
      } catch {
        tbody.innerHTML = `<tr>
          <td colspan="3" class="p-4 text-center text-red-400 animate-fadein">
            <span class="text-2xl">‚ùå</span> Gagal memuat data.
          </td>
        </tr>`;
      }
    }

    // üîë Ganti Password Reseller
    async function gantiPasswordReseller(username) {
      const newPassword = document.getElementById('newpass-' + username).value.trim();
      if (!newPassword) return showNotifyModal('Password baru wajib diisi', "‚ö†Ô∏è");
      const res = await fetch('/api/resellers', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, newPassword })
      });
      const msg = await res.json();
      showNotifyModal(msg.error || msg.message, msg.error ? "‚ùå" : "‚úÖ");
      loadResellers();
    }

    // ‚ùå Hapus Reseller
    async function deleteReseller(username) {
      if (!confirm(`Yakin ingin menghapus reseller "${username}"?`)) return;
      const res = await fetch("/api/resellers", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      if (res.ok) {
        loadResellers();
        showNotifyModal("Reseller dihapus!", "‚úÖ");
      } else {
        showNotifyModal("Gagal menghapus reseller.", "‚ùå");
      }
    }

    // üñ•Ô∏è List Server/Panel
    async function loadServers() {
      const tbody = document.getElementById('serverTable');
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-indigo-300 animate-fadein">Memuat...</td></tr>`;
      try {
        const res = await fetch("/api/list-panels");
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-300 animate-fadein">Belum ada panel/server.</td></tr>`;
          return;
        }
        tbody.innerHTML = "";
        data.forEach(s => {
          tbody.innerHTML += `
            <tr class="border-b border-slate-800">
              <td class="p-3">${s.id || ''}</td>
              <td class="p-3">${s.name || ''}</td>
              <td class="p-3">${s.owner || ''}</td>
              <td class="p-3">${s.status || ''}</td>
            </tr>
          `;
        });
      } catch {
        tbody.innerHTML = `<tr>
          <td colspan="4" class="p-4 text-center text-red-400 animate-fadein">
            <span class="text-2xl">‚ùå</span> Gagal memuat data.
          </td>
        </tr>`;
      }
    }

    // INIT
    window.onload = function() {
      loadResellers();
      loadServers();
    }
  </script>
</body>
</html>