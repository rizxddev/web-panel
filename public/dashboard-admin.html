<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - RizxMods</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white relative">

  <!-- Tombol Logout -->
  <button onclick="logout()" class="absolute top-6 right-6 bg-rose-600 hover:bg-rose-700 px-5 py-2 rounded-lg font-bold shadow text-white text-base transition active:scale-95 z-30">
    Logout
  </button>

  <!-- ‚úÖ Konten Admin -->
  <div id="adminContent" class="p-6">
    <h1 class="text-xl font-bold mb-4">üëë Admin Panel - RizxMods</h1>

    <!-- üîò Tombol Tambah Admin & Reseller -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button onclick="openAddAdmin()" class="bg-indigo-600 hover:bg-indigo-700 p-2 rounded">+ Tambah Admin Pterodactyl</button>
      <button onclick="openAddReseller()" class="bg-green-600 hover:bg-green-700 p-2 rounded">+ Tambah Reseller</button>
    </div>

    <!-- üìã Daftar Reseller -->
    <div>
      <h2 class="text-lg font-semibold mb-2">üìÇ Daftar Reseller</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="resellerTable">
          <thead>
            <tr class="bg-slate-700">
              <th class="p-2">Username</th>
              <th class="p-2">Ganti Password</th>
              <th class="p-2">Aksi</th>
            </tr>
          </thead>
          <tbody class="bg-slate-800"></tbody>
        </table>
      </div>
    </div>

    <!-- üñ•Ô∏è List Panel/Server -->
    <div class="mt-10">
      <h2 class="text-lg font-semibold mb-2">üñ•Ô∏è List Panel/Server</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="serverTable">
          <thead>
            <tr class="bg-slate-700">
              <th class="p-2">ID</th>
              <th class="p-2">Nama Panel</th>
              <th class="p-2">Pemilik</th>
              <th class="p-2">Status</th>
            </tr>
          </thead>
          <tbody class="bg-slate-800"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal Tambah Reseller -->
  <div id="addResellerModal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden">
    <form id="addResellerForm" class="bg-slate-800 p-6 rounded w-full max-w-sm mx-4 space-y-3 shadow-xl">
      <h2 class="text-lg font-bold text-center">‚ûï Tambah Reseller</h2>
      <input type="text" id="newResellerUsername" placeholder="Username" required class="w-full p-3 bg-slate-700 rounded" />
      <input type="password" id="newResellerPassword" placeholder="Password" required class="w-full p-3 bg-slate-700 rounded" />
      <div class="flex gap-2">
        <button type="submit" class="bg-green-600 p-2 rounded w-full">Simpan</button>
        <button type="button" onclick="closeAddReseller()" class="bg-red-600 p-2 rounded w-full">Batal</button>
      </div>
    </form>
  </div>

  <!-- ‚úÖ Modal Tambah Admin Pterodactyl -->
  <div id="addAdminModal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden">
    <form id="addAdminForm" class="bg-slate-800 p-6 rounded w-full max-w-sm mx-4 space-y-3 shadow-xl">
      <h2 class="text-lg font-bold text-center">‚ûï Tambah Admin Pterodactyl</h2>
      <input type="text" id="newAdminUsername" placeholder="Username Admin" required class="w-full p-3 bg-slate-700 rounded" />
      <div class="flex gap-2">
        <button type="submit" class="bg-indigo-600 p-2 rounded w-full">Simpan</button>
        <button type="button" onclick="closeAddAdmin()" class="bg-red-600 p-2 rounded w-full">Batal</button>
      </div>
      <p class="text-xs text-slate-400 mt-2 text-center">Password acak & email otomatis dari username.</p>
    </form>
  </div>

  <!-- ‚úÖ Modal Notifikasi Animasi -->
  <div id="notifyModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
    <div class="bg-slate-800 px-7 py-7 rounded-2xl shadow-xl text-center animate-pop">
      <div class="text-3xl mb-2 animate-celebrate" id="notifyIcon">‚úÖ</div>
      <div class="font-bold text-lg mb-2" id="notifyMsg"></div>
      <button onclick="closeNotifyModal()" class="mt-3 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold shadow animate-btnpop">Tutup</button>
    </div>
  </div>

  <!-- ‚úÖ Modal Sukses Tambah Admin -->
  <div id="successAdminModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-60 hidden">
    <div class="bg-slate-800 px-5 py-7 sm:px-8 sm:py-10 rounded-2xl shadow-xl text-center animate-pop w-[95vw] max-w-xs sm:max-w-md">
      <div class="text-6xl mb-4 animate-celebrate">üéâ</div>
      <div class="font-bold text-2xl sm:text-3xl mb-4 text-indigo-300">Akun Admin Pterodactyl Berhasil Dibuat!</div>
      <div id="adminAccessInfo" class="mb-2 text-white space-y-3"></div>
      <button onclick="closeSuccessAdminModal()" class="mt-6 px-8 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl text-white font-semibold text-lg shadow w-full transition active:scale-95">
        Tutup
      </button>
    </div>
  </div>

  <style>
    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0;}
      100% { transform: scale(1); opacity: 1;}
    }
    .animate-pop { animation: pop 0.25s cubic-bezier(.4,2,.6,1);}
    @keyframes celebrate {
      0%,100% { transform: rotate(0deg);}
      20% { transform: rotate(-10deg);}
      40% { transform: rotate(10deg);}
      60% { transform: rotate(-6deg);}
      80% { transform: rotate(6deg);}
    }
    .animate-celebrate { animation: celebrate 0.9s; }
    @keyframes btnpop {
      0% { transform: scale(0.95);}
      100% { transform: scale(1);}
    }
    .animate-btnpop { animation: btnpop 0.22s; }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-24px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .animate-fadein { animation: fadein 0.8s cubic-bezier(.4,2,.6,1);}
    .copy-btn {
      cursor: pointer;
      padding: 3px 9px;
      background: #262b3b;
      color: #67e8f9;
      border-radius: 6px;
      font-size: 0.95em;
      margin-left: 8px;
      transition: background 0.15s;
      border: none;
    }
    .copy-btn:hover { background: #334155; color: #38bdf8;}
    .select-all { user-select: all; }
  </style>

  <script>
    // Auth check: harus login sebagai admin!
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token || role !== "admin") {
      window.location.href = "/login-admin.html";
    }

    // Modal notifikasi animasi
    function showNotifyModal(msg, icon="‚úÖ") {
      document.getElementById("notifyMsg").innerText = msg;
      document.getElementById("notifyIcon").innerText = icon;
      document.getElementById("notifyModal").classList.remove("hidden");
    }
    function closeNotifyModal() {
      document.getElementById("notifyModal").classList.add("hidden");
    }

    // ‚ûï Modal Tambah Reseller
    function openAddReseller() {
      document.getElementById("addResellerModal").classList.remove("hidden");
    }
    function closeAddReseller() {
      document.getElementById("addResellerModal").classList.add("hidden");
    }

    // üìù Tambah Reseller
    document.getElementById("addResellerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("newResellerUsername").value.trim();
      const password = document.getElementById("newResellerPassword").value.trim();
      const res = await fetch("/api/resellers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        closeAddReseller();
        loadResellers();
        showNotifyModal("Reseller ditambahkan!", "‚úÖ");
      } else {
        showNotifyModal("Gagal menambah reseller.", "‚ùå");
      }
    });

    // ‚ûï Modal Tambah Admin Pterodactyl
    function openAddAdmin() {
      document.getElementById("addAdminModal").classList.remove("hidden");
    }
    function closeAddAdmin() {
      document.getElementById("addAdminModal").classList.add("hidden");
    }

    // üìù Tambah Admin Pterodactyl
    document.getElementById("addAdminForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("newAdminUsername").value.trim();
      // Email otomatis & password random di backend!
      const res = await fetch("/api/admins", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      const data = await res.json();
      if (res.ok) {
        closeAddAdmin();
        showSuccessAdminModal({ username: data.username, password: data.password, domain: data.domain });
      } else {
        showNotifyModal(data.error || "Gagal menambah admin panel.", "‚ùå");
      }
    });

    // Modal Sukses Tambah Admin + Copy Data Akun
    function showSuccessAdminModal(data = {}) {
      document.getElementById("adminAccessInfo").innerHTML = `
        <div>
          <b>üë§ Username:</b>
          <span id="adminCopyUser" class="select-all">${data.username || '-'}</span>
          <button class="copy-btn" onclick="copyText('adminCopyUser')">Salin</button>
        </div>
        <div>
          <b>üîë Password:</b>
          <span id="adminCopyPass" class="select-all">${data.password || '-'}</span>
          <button class="copy-btn" onclick="copyText('adminCopyPass')">Salin</button>
        </div>
        <div>
          <b>üåê Domain Panel:</b>
          <span id="adminCopyDomain" class="select-all">${data.domain || (window.location.origin)}</span>
          <button class="copy-btn" onclick="copyText('adminCopyDomain')">Salin</button>
        </div>
      `;
      document.getElementById("successAdminModal").classList.remove("hidden");
    }
    function closeSuccessAdminModal() {
      document.getElementById("successAdminModal").classList.add("hidden");
    }

    // Fungsi copy ke clipboard
    function copyText(id) {
      const text = document.getElementById(id).textContent;
      navigator.clipboard.writeText(text);
    }

    // üìã List Reseller + Ganti Password
    async function loadResellers() {
      const tbody = document.querySelector('#resellerTable tbody');
      tbody.innerHTML = "<tr><td colspan='3' class='p-3 text-center'>Memuat...</td></tr>";
      try {
        const res = await fetch("/api/resellers");
        const data = await res.json();
        let resArr = Array.isArray(data) ? data : data.resellers || [];
        if (!resArr.length) {
          tbody.innerHTML = "<tr><td colspan='3' class='p-3 text-center'>Belum ada reseller.</td></tr>";
          return;
        }
        tbody.innerHTML = "";
        resArr.forEach(r => {
          tbody.innerHTML += `
            <tr>
              <td class="p-2">@${r.username}</td>
              <td class="p-2">
                <input type="password" id="newpass-${r.username}" class="bg-slate-700 rounded px-2 text-sm" placeholder="Password baru" />
                <button onclick="gantiPasswordReseller('${r.username}')" class="ml-2 bg-yellow-500 text-slate-900 px-2 rounded text-xs">Simpan</button>
              </td>
              <td class="p-2">
                <button onclick="deleteReseller('${r.username}')" class="bg-red-600 rounded px-2 text-xs">Hapus</button>
              </td>
            </tr>
          `;
        });
      } catch {
        tbody.innerHTML = "<tr><td colspan='3' class='p-3 text-center text-red-400'>‚ùå Gagal memuat data.</td></tr>";
      }
    }

    // üîë Ganti Password Reseller
    async function gantiPasswordReseller(username) {
      const newPassword = document.getElementById('newpass-' + username).value.trim();
      if (!newPassword) return showNotifyModal('Password baru wajib diisi', "‚ö†Ô∏è");
      const res = await fetch('/api/resellers', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, newPassword })
      });
      const msg = await res.json();
      showNotifyModal(msg.error || msg.message, msg.error ? "‚ùå" : "‚úÖ");
      loadResellers();
    }

    // ‚ùå Hapus Reseller
    async function deleteReseller(username) {
      if (!confirm(`Yakin ingin menghapus reseller "${username}"?`)) return;
      const res = await fetch("/api/resellers", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      if (res.ok) {
        loadResellers();
        showNotifyModal("Reseller dihapus!", "‚úÖ");
      } else {
        showNotifyModal("Gagal menghapus reseller.", "‚ùå");
      }
    }

    // üñ•Ô∏è List Server/Panel
    async function loadServers() {
      const tbody = document.querySelector('#serverTable tbody');
      tbody.innerHTML = "<tr><td colspan='4' class='p-3 text-center'>Memuat...</td></tr>";
      try {
        const res = await fetch("/api/list-panels");
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          tbody.innerHTML = "<tr><td colspan='4' class='p-3 text-center'>Belum ada panel/server.</td></tr>";
          return;
        }
        tbody.innerHTML = "";
        data.forEach(s => {
          tbody.innerHTML += `
            <tr>
              <td class="p-2">${s.id || ''}</td>
              <td class="p-2">${s.name || ''}</td>
              <td class="p-2">${s.owner || ''}</td>
              <td class="p-2">${s.status || ''}</td>
            </tr>
          `;
        });
      } catch {
        tbody.innerHTML = "<tr><td colspan='4' class='p-3 text-center text-red-400'>‚ùå Gagal memuat data.</td></tr>";
      }
    }

    // INIT
    window.onload = function() {
      loadResellers();
      loadServers();
    }

    // Fungsi logout
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("role");
      window.location.href = "/";
    }
  </script>
</body>
</html>
